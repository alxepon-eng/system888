// --- ตั้งค่า ID ---
var SHEET_ID = '1WhgMytmfWT5osX06fBCd9pSqVpHCOQ-bm84lH6M9KGc';
var FOLDER_ID = '1GduzdhB0Ec_NfZDnLMUBTGGnWIKfRdyn';

function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);
  
  try {
    var data = JSON.parse(e.postData.contents);
    var action = data.action || 'SUBMIT'; // ตรวจสอบ action
    
    // 1. กรณีดึงข้อมูล (Get Submissions)
    if (action === 'GET_SUBMISSIONS') {
      var submissions = getSubmissions();
      return createJsonResponse({ status: 'success', data: submissions });
    }

    // 2. กรณีอัปเดตคะแนน (Update Grade)
    if (action === 'UPDATE_GRADE') {
      var result = updateGrade(data.rowId, data.score, data.feedback);
      return createJsonResponse(result);
    }
    
    // 3. กรณีส่งงาน (Submit - นักเรียน) หรือ มอบหมายงาน (Teacher)
    // (ใช้โค้ดเดิมแต่ปรับให้รองรับ action)
    var ss = SpreadsheetApp.openById(SHEET_ID);
    var sheetName = data.role === 'TEACHER' ? 'Assignments' : 'Submissions';
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      if (data.role === 'TEACHER') {
         sheet.appendRow(['Timestamp', 'TargetGroup', 'Subject', 'Topic', 'DueDate', 'FileUrl']);
      } else {
         sheet.appendRow(['Timestamp', 'Group', 'Subject', 'AssignmentTitle', 'Members', 'Link', 'FileUrl', 'Score', 'Feedback']);
      }
    }
    
    var fileUrl = '';
    if (data.fileData) {
      var folder = DriveApp.getFolderById(FOLDER_ID);
      var contentType = data.fileData.base64.substring(5, data.fileData.base64.indexOf(';'));
      var bytes = Utilities.base64Decode(data.fileData.base64);
      var blob = Utilities.newBlob(bytes, data.fileData.type, data.fileData.name);
      var file = folder.createFile(blob);
      fileUrl = file.getUrl();
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    }
    
    if (data.role === 'TEACHER') {
      sheet.appendRow([
        data.timestamp,
        data.targetGroup,
        data.subject,
        data.topic,
        data.dueDate,
        fileUrl
      ]);
      // TODO: เพิ่มโค้ดส่ง Email/Line Notify แจ้งเตือนนักเรียนที่นี่
    } else {
      // Student Submission
      var membersStr = JSON.stringify(data.members);
      sheet.appendRow([
        data.timestamp,
        data.group,
        data.subject,
        data.assignmentTitle,
        membersStr,
        data.link,
        fileUrl,
        '', // Score (Empty initially)
        ''  // Feedback (Empty initially)
      ]);
      // TODO: เพิ่มโค้ดส่ง Email แจ้งเตือนครูที่นี่
    }
    
    return createJsonResponse({ status: 'success', message: 'บันทึกข้อมูลสำเร็จ', fileUrl: fileUrl });
    
  } catch (e) {
    return createJsonResponse({ status: 'error', message: e.toString() });
  } finally {
    lock.releaseLock();
  }
}

function getSubmissions() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sheet = ss.getSheetByName('Submissions');
  if (!sheet) return [];
  
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var results = [];
  
  // เริ่มแถวที่ 2 (index 1)
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    // Mapping ตามลำดับคอลัมน์: Timestamp, Group, Subject, Title, Members, Link, FileUrl, Score, Feedback
    // เพิ่ม rowId (คือเลขแถว i+1) เพื่อใช้อ้างอิงตอนให้คะแนน
    try {
       results.push({
          rowId: i + 1, 
          timestamp: row[0],
          group: row[1],
          subject: row[2],
          assignmentTitle: row[3],
          members: JSON.parse(row[4] || '[]'),
          link: row[5],
          fileUrl: row[6],
          score: row[7],
          feedback: row[8]
       });
    } catch(e) {
       // Skip errors
    }
  }
  // เรียงลำดับจากใหม่ไปเก่า
  return results.reverse();
}

function updateGrade(rowId, score, feedback) {
   var ss = SpreadsheetApp.openById(SHEET_ID);
   var sheet = ss.getSheetByName('Submissions');
   
   // เช็คว่า rowId อยู่ในขอบเขตหรือไม่
   if (rowId > sheet.getLastRow() || rowId < 2) {
      return { status: 'error', message: 'ไม่พบข้อมูลแถวที่ระบุ' };
   }
   
   // คอลัมน์ Score คือ 8, Feedback คือ 9 (index เริ่ม 1)
   sheet.getRange(rowId, 8).setValue(score);
   sheet.getRange(rowId, 9).setValue(feedback);
   
   return { status: 'success', message: 'อัปเดตคะแนนแล้ว' };
}

function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
